@model IEnumerable<AppointmentSystem.Models.ViewModels.BaseInfoModels.TreatmentIndexVM>
@{
    ViewData["Title"] = "療程基本資料";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    #imageName {
        margin-left: 10px;
    }

    .add-sidebaritem {
        
        color: #5e1a1a;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .form-control {
        border-color: #B3B3B3 !important;
        border-radius: 10px !important;
        width: 50% !important;
        margin-left: 15px !important;
    }

        .form-control.textarea {
            width: 50% !important;
        }

    .active {
        background-color: #5BC2E7 !important;
        border: none;
    }
    /*     .add-sidebaritem {
                                                                    background-color: #ffffff;
                                                                    color: #5e1a1a;
                                                                    border: none;
                                                                    border-radius: 50%;
                                                                    width: 40px;
                                                                    height: 40px;
                                                                    display: flex;
                                                                    align-items: center;
                                                                    justify-content: center;
                                                                    font-size: 24px;
                                                                } */

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

    .sidebar, .right-panel {
        margin: 15px;
        padding: 30px;
        border-radius: 15px;
    }
</style>

<script src="~/js/jquery-ui.js"></script>
<link rel="stylesheet" href="~/css/jquery-ui.css">

<div class="container content-div" style="justify-content: center;">
    <h3 class="container " style="text-align:start; margin:10px;">@ViewData["Title"]</h3>

    <div class="row" style="justify-content: center;">
        <div class="col-md-3 sidebar" style="background-color:#F7F6EE;box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);" id="sidebar">
            @{
                int i = 0;
            }

            <div class="sortable">
                @foreach (var item in Model)
                {
                    <ul class="input-group" style="padding-inline-start: 0px;">
                        <li class="form-control " id="tb-@i" onclick="showTreatmentDetail('@i');" style="cursor:pointer;">
                            @item.TreatmentName
                            <input type="hidden" id="tv-@i" value="@item.TreatmentId" />
                        </li>
                    </ul>

                    i++;
                }
            </div>

            <button class="add-sidebaritem" style="margin:auto" onclick="addTreatment();"> <img src="/images/add_circle_24dp_0E4F43_FILL0_wght400_GRAD0_opsz24.png" style="width:40px;height:40px ;" \></button>
        </div>

        <div class="col-md-8 right-panel" style="text-align:left; box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);" id="treatmentData">
        </div>
    </div>
</div>



<div class="modal fade" id="addLabelModal" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalTitle">新增標籤</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="labelName">輸入標籤名稱：</label>
                    <input type="text" class="form-control" id="labelName" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submitBtn" onclick="creatLabel();">送出</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(function () {
        $(".sortable").sortable({
            // handle: 'button',
            placeholder: "ui-state-highlight", // 可選，為拖動時的占位符樣式
            update: function (event, ui) {
                var items = [];
                $('[id^="tv-"]').each(function () {
                    items.push(this.value);
                });

                $.ajax({
                    type: "POST",
                    url: "/BaseInfo/saveTreatmentSort",
                    datatype: "json",
                    data: { items: items },
                    success: function (data) {
                        console.log(data);
                    }
                });

                // 你可以在這裡添加 AJAX 調用以保存新順序
            }
        });
        $(".sortable").disableSelection(); // 防止在拖動時選中文字
    });

    // $(document).ready(function () {
    //     $("#FileButton").click(function () {
    //         $("#uploadImage").click();
    //     });
    // });

    function creatLabel() {
        var labelName = $('#labelName').val();

        if (labelName) {
            createTreatmentLabelName(labelName);

            $('#addLabelModal').modal('hide');
        } else {
            alert("請輸入標籤名稱！");
        }
    }

    function createTreatmentLabelName(name) {
        $.ajax({
            type: "GET",
            url: "/BaseInfo/TreatmentLabelNameCreate",
            datatype: "json",
            data: { "name": name },
            success: function (data) {
                console.log("Create label successful.");
                refreshLabelList();
            }
        });
    }

    function refreshLabelList() {
        let treatmentId = $("#treatmentId").val();

        $.ajax({
            type: "GET",
            url: "/BaseInfo/GetTreatmentLabelList",
            datatype: "json",
            data: { id: treatmentId },
            success: function (data) {
                console.log(data);

                let inner = "";
                inner += '<div class="btn-group-toggle container" data-toggle="buttons">';

                data.forEach((item) => {
                    if (item.isChecked == "Y") {
                        inner += '<label class="btn btn-secondary btn-checkbox active" style="cursor:pointer;">';
                        inner += '<input type="checkbox" name="labels" value="' + item.labelId + '" autocomplete="off" checked> ' + item.labelName;
                        inner += '</label> ';
                    } else {
                        inner += '<label class="btn btn-secondary btn-checkbox" style="cursor:pointer;">';
                        inner += '<input type="checkbox" name="labels" value="' + item.labelId + '" autocomplete="off"> ' + item.labelName;
                        inner += '</label> ';
                    }
                });

                inner += '</div>';

                $('#labelList').html(inner);

            }
        });
    }

    function showLabelAddModal() {
        $('#addLabelModal').modal('show');
    }

    // function editTreatment(i) {
    //     let text = document.getElementById("treatment-" + i);
    //     let btn = document.getElementById("tb-" + i);
    //     let tv = document.getElementById("tv-" + i);
    //     let img = document.getElementById("img-" + i);

    //     if (text.value == "") {
    //         alert("請輸入療程名稱!!");
    //     } else {
    //         if (text.style.display == "") {
    //             //新增療程(僅名稱)
    //             if (tv.value == "") {
    //                 $.ajax({
    //                     type: "GET",
    //                     url: "/BaseInfo/TreatmentNameCreate",
    //                     datatype: "json",
    //                     data: { "name": text.value },
    //                     success: function (data) {
    //                         console.log("Create treatment successful.");
    //                         tv.value = data;
    //                         showTreatmentDetail(i)
    //                     }
    //                 });
    //             } else {
    //                 $.ajax({
    //                     type: "GET",
    //                     url: "/BaseInfo/TreatmentNameUpdate",
    //                     datatype: "json",
    //                     data: { "name": text.value, "id": tv.value },
    //                     success: function (data) {
    //                         console.log("Update treatment successful.");
    //                         tv.value = data;
    //                         showTreatmentDetail(i)
    //                     }
    //                 });
    //             }

    //             btn.innerHTML = text.value;
    //             text.style.display = "none";
    //             btn.style.display = "";
    //             img.src = "/images/inkmarker.png";
    //         }
    //         else {
    //             text.style.display = "";
    //             btn.style.display = "none";
    //             img.src = "/images/check.png";
    //         }
    //     }
    // }

    function showTreatmentDetail(i) {
        let $tv = $("#tv-" + i);

        $.ajax({
            type: "GET",
            url: "/BaseInfo/GetTreatmentDetailData",
            datatype: "json",
            data: { id: $tv.val() },
            success: function (data) {
                console.log(data);

                var inner = "";

                inner += "<div style='display: flex;vertical-align:central;align-items: center'>";
                inner += '<h3 class="mt-4 mb-4" style="display: flex;"><label>療程名稱：' + data.treatmentName + '</label></h3>';

                inner += '<button class="icon-button mr-1" style="display: flex;">';
                if (data.hide == "Y") {
                    inner += '<img src="/images/VisibilityOff.png" id = "vis-' + data.treatmentId + '" style = "height:2em;width:auto;" onclick = "setTreatmentHide(\'' + data.treatmentId + '\',\'N\');" />';
                    inner += '<img src="/images/Visibility.png" id = "vih-' + data.treatmentId + '" style = "height:2em;width:auto;display:none;" onclick = "setTreatmentHide(\'' + data.treatmentId + '\',\'Y\');" />';
                }
                else {
                    inner += '<img src="/images/VisibilityOff.png" id = "vis-' + data.treatmentId + '" style = "height:2em;width:auto;display:none;" onclick = "setTreatmentHide(\'' + data.treatmentId + '\',\'N\');" />';
                    inner += '<img src="/images/Visibility.png" id = "vih-' + data.treatmentId + '" style = "height:2em;width:auto;" onclick = "setTreatmentHide(\'' + data.treatmentId + '\',\'Y\');" />';
                }
                inner += '</button>';

                inner += "</div>";


                inner += '<input type="hidden" id="treatmentId" value="' + data.treatmentId + '" />';

                inner += '<div class="form-group"><label for="treatmentName">療程名稱*</label><input type="text" class="form-control" id="treatmentName" placeholder="輸入療程名稱" value="' + data.treatmentName + '" /></input></div>';
                inner += '<div class="form-group"><label for="introduction" class="ml-3 mb-3">療程介紹*</label><textarea class="form-control textarea ml-5" id="introduction" rows="3" placeholder="輸入療程介紹" required="">' + data.introduction + '</textarea></div>';
                inner += '<div class="form-group"><label for="alertMessage">衛教發送訊息*</label><textarea class="form-control" id="alertMessage" rows="3" placeholder="輸入衛教發送訊息" required="">' + data.alertMessage + '</textarea></div>';

                //產生諮詢時間下拉式選單
                inner += '<div class="form-group"><label for="time">諮詢時間*</label>';
                inner += '<select class="form-control" id="time" required="">';

                data.timeSelectList.forEach((item) => {
                    if (data.time == item.value)
                        inner += '<option value="' + item.value + '" selected = "selected">' + item.text + '</option>';
                    else
                        inner += '<option value="' + item.value + '">' + item.text + '</option>';
                });

                inner += '</select>';
                inner += '</div>';

                // inner += '<div class="form-group"><label for="sort">排序*</label><input type="number" class="form-control" id="sort" value="' + data.sort + '" placeholder="輸入排序" required=""></div>';
                inner += '<div class="form-group"><label for="memo">備註</label><textarea class="form-control" id="memo" rows="3" placeholder="輸入備註">' + data.memo + '</textarea></div>';
                inner += '<div class="form-group d-flex align-items-center"><label class="mr-2">圖片上傳*</label><input type="file" class="form-control-file" id="imagefile" onchange="setImageName();" style="display:none;" /> <label class="col-form-label btn btn-primary mb-0" onclick="uploadImageClick();" style="cursor:pointer;border:none;border-radius:100px;  background-color:transparent;border: 2px solid #4A707A;padding:2px;"><img src="/images/cloud_upload_24dp_4A707A_FILL0_wght400_GRAD0_opsz24.png" alt="Alternate Text" style="width:25px;height:25px; " /></label><div><label id="imageName" class="ml-2">' + data.treatmentImage.fileName + data.treatmentImage.fileExtension + '</label></div></div>';

                //產生標籤清單
                inner += '<div class="form-group d-flex align-items-center"><label class="mr-2">選擇標籤</label><label class="col-form-label btn btn-primary mb-0" onclick="showLabelAddModal();" style="cursor:pointer;border:none;background-color: #385466 ;color: #F7F6EE;border-radius: 10px;">新增標籤</label></div>';

                inner += '<div class="form-group" id="labelList">';
                inner += '<div class="btn-group-toggle container" data-toggle="buttons">';

                data.labelList.forEach((item) => {
                    if (item.isChecked == "Y") {
                        inner += '<label class="btn btn-secondary btn-checkbox active" style="cursor:pointer;border-radius: 10px;">';
                        inner += '<input type="checkbox" name="labels" value="' + item.labelId + '" autocomplete="off" checked> ' + item.labelName;
                        inner += '</label> ';
                    } else {
                        inner += '<label class="btn btn-secondary btn-checkbox" style="cursor:pointer;border-radius: 10px;">';
                        inner += '<input type="checkbox" name="labels" value="' + item.labelId + '" autocomplete="off"> ' + item.labelName;
                        inner += '</label> ';
                    }
                });

                inner += '</div>';
                inner += '</div>';

                inner += '<button class="btn btn-primary" style="cursor:pointer;border:none;background-color: #385466 ;color: #F7F6EE;border-radius: 10px;"onclick="updateTreatment();">儲存</button> <button class="btn btn-primary" style="cursor:pointer;border:none;background-color: #385466 ;color: #F7F6EE;border-radius: 10px;" onclick="cleanTreatmentData();">取消</button>';

                $("#treatmentData").html(inner);
            }
        });
    }

    function uploadImageClick() {
        $("#imagefile").click();
    }

    function cleanTreatmentData() {
        $("#treatmentData").html("");
    }

    function setImageName() {
        if ($('#imagefile').val == "")
            $('#imageName').text("");


        $('#imageName').text($('#imagefile').val().split('\\').pop());
    }

    function addTreatment() {
        $.ajax({
            type: "GET",
            url: "/BaseInfo/GetTreatmentCreateVM",
            datatype: "json",
            success: function (data) {
                var inner = "";

                inner += '<input type="hidden" id="treatmentId" value="" />';

                inner += '<div class="form-group"><label for="treatmentName">療程名稱*</label><input type="text" class="form-control" id="treatmentName" placeholder="輸入療程名稱" value="" /></input></div>';
                inner += '<div class="form-group"><label for="introduction" class="ml-3 mb-3">療程介紹*</label><textarea class="form-control textarea ml-5" id="introduction" rows="3" placeholder="輸入療程介紹" required=""></textarea></div>';
                inner += '<div class="form-group"><label for="alertMessage">衛教發送訊息*</label><textarea class="form-control" id="alertMessage" rows="3" placeholder="輸入衛教發送訊息" required=""></textarea></div>';

                //產生諮詢時間下拉式選單
                inner += '<div class="form-group"><label for="time">諮詢時間*</label>';
                inner += '<select class="form-control" id="time" required="">';

                data.timeSelectList.forEach((item) => {
                    inner += '<option value="' + item.value + '">' + item.text + '</option>';
                });

                inner += '</select>';
                inner += '</div>';

                // inner += '<div class="form-group"><label for="sort">排序*</label><input type="number" class="form-control" id="sort" value="" placeholder="輸入排序" required=""></div>';
                inner += '<div class="form-group"><label for="memo">備註</label><textarea class="form-control" id="memo" rows="3" placeholder="輸入備註"></textarea></div>';
                inner += '<div class="form-group d-flex align-items-center"><label class="mr-2">圖片上傳*</label><input type="file" class="form-control-file" id="imagefile" onchange="setImageName();" style="display:none;" /> <label class="col-form-label btn btn-primary mb-0" onclick="uploadImageClick();" style="cursor:pointer;border:none;border-radius:100px;  background-color:transparent;border: 2px solid #4A707A;padding:2px;"><img src="/images/cloud_upload_24dp_4A707A_FILL0_wght400_GRAD0_opsz24.png" alt="Alternate Text" style="width:25px;height:25px; " /></label><div><label id="imageName" class="ml-2"></label></div></div>';

                //產生標籤清單
                inner += '<div class="form-group d-flex align-items-center"><label class="mr-2">選擇標籤</label><label class="col-form-label btn btn-primary mb-0" onclick="showLabelAddModal();" style="cursor:pointer;border:none;background-color: #385466 ;color: #F7F6EE;border-radius: 10px;">新增標籤</label></div>';

                inner += '<div class="form-group" id="labelList">';
                inner += '<div class="btn-group-toggle container" data-toggle="buttons">';

                data.labelList.forEach((item) => {
                    if (item.isChecked == "Y") {
                        inner += '<label class="btn btn-secondary btn-checkbox active" style="cursor:pointer;border-radius: 10px;">';
                        inner += '<input type="checkbox" name="labels" value="' + item.labelId + '" autocomplete="off" checked> ' + item.labelName;
                        inner += '</label> ';
                    } else {
                        inner += '<label class="btn btn-secondary btn-checkbox" style="cursor:pointer;border-radius: 10px;">';
                        inner += '<input type="checkbox" name="labels" value="' + item.labelId + '" autocomplete="off"> ' + item.labelName;
                        inner += '</label> ';
                    }
                });

                inner += '</div>';
                inner += '</div>';

                inner += '<button class="btn btn-primary" style="cursor:pointer;border:none;background-color: #385466 ;color: #F7F6EE;border-radius: 10px;"onclick="createTreatment();">儲存</button> <button class="btn btn-primary" style="cursor:pointer;border:none;background-color: #385466 ;color: #F7F6EE;border-radius: 10px;" onclick="cleanTreatmentData();">取消</button>';

                $("#treatmentData").html(inner);
            }
        });




        // let $sidebar = $('.sidebar');
        // let itemNo = $sidebar.find('.input-group').length + 1;

        // let $newItem = $(`
        //         <div class="input-group">
        //             <button class="icon-button mr-1">
        //                 <img src="/images/Visibility.png" id="vis-${itemNo}" style="height:2em;width:auto;" onclick="setTreatmentShow(${itemNo});" />
        //                 <img src="/images/VisibilityOff.png" id="vih-${itemNo}" style="height:2em;width:auto;display:none;" onclick="setTreatmentHide(${itemNo});" />
        //             </button>
        //             <button class="form-control treatment-item" id="tb-${itemNo}" onclick="showTreatmentDetail('${itemNo}');" style="display:none;"></button>
        //                     <input type="text" id="treatment-${itemNo}" class="form-control treatment-item" placeholder="請輸入療程名稱..." value="" style="text-align:center;" />
        //             <button class="icon-button" onclick="editTreatment('${itemNo}');">
        //                 <img src="/images/check.png"  class="ml-1" id="img-${itemNo}" style="height:2em;width:auto;" />
        //             </button>
        //             <input type="hidden" id="tv-${itemNo}" value="" />
        //         </div>
        //     `);

        // $sidebar.find('.add-sidebaritem').before($newItem);
    }

    function updateTreatment() {
        let alertMsg = "";

        var selectedLabels = [];
        document.querySelectorAll('input[name="labels"]:checked').forEach(function (checkbox) {
            selectedLabels.push(checkbox.value);
        });

        if ($('#treatmentName').val() == "")
            alertMsg = "請輸入療程名稱!!";
        else if ($('#introduction').val() == "")
            alertMsg = "請輸入療程介紹!!";
        else if ($('#time').val() == "")
            alertMsg = "請輸入療程時間!!";
        else if ($('#AlertMessage').val() == "")
            alertMsg = "請輸入衛教發送訊息!!";
        else if ($('#imageName').html() == "")
            alertMsg = "請上傳圖片!!";

        if (alertMsg != "") {
            alert(alertMsg);
            return false;
        }

        var formData = new FormData();
        formData.append('TreatmentId', $('#treatmentId').val());
        formData.append('TreatmentName', $('#treatmentName').val());
        formData.append('Introduction', $('#introduction').val());
        formData.append('Time', $('#time').val());
        formData.append('AlertMessage', $('#alertMessage').val());
        formData.append('Memo', $('#memo').val());
        formData.append('TreatmentImage.File', $('#imagefile')[0].files[0]);
        formData.append('SelectedLabel', selectedLabels);

        $.ajax({
            url: '/BaseInfo/TreatmentUpdate',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert('儲存成功');
                // $("#treatmentData").html("");
                location.reload()
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('儲存失敗，請聯絡系統管理員');
            }
        });
    }

    function createTreatment() {
        let alertMsg = "";

        var selectedLabels = [];
        document.querySelectorAll('input[name="labels"]:checked').forEach(function (checkbox) {
            selectedLabels.push(checkbox.value);
        });

        if ($('#treatmentName').val() == "")
            alertMsg = "請輸入療程名稱!!";
        else if ($('#introduction').val() == "")
            alertMsg = "請輸入療程介紹!!";
        else if ($('#time').val() == "")
            alertMsg = "請輸入療程時間!!";
        else if ($('#AlertMessage').val() == "")
            alertMsg = "請輸入衛教發送訊息!!";
        else if ($('#imageName').html() == "")
            alertMsg = "請上傳圖片!!";

        if (alertMsg != "") {
            alert(alertMsg);
            return false;
        }

        var formData = new FormData();
        formData.append('TreatmentId', $('#treatmentId').val());
        formData.append('TreatmentName', $('#treatmentName').val());
        formData.append('Introduction', $('#introduction').val());
        formData.append('Time', $('#time').val());
        formData.append('AlertMessage', $('#alertMessage').val());
        formData.append('Memo', $('#memo').val());
        formData.append('TreatmentImage.File', $('#imagefile')[0].files[0]);
        formData.append('SelectedLabel', selectedLabels);

        $.ajax({
            url: '/BaseInfo/TreatmentCreate',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert('儲存成功');
                // $("#treatmentData").html("");
                location.reload()
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('儲存失敗，請聯絡系統管理員');
            }
        });
    }

    // function setTreatmentShow(id) {



    //     if (id == "") {
    //         alert("查無療程資料，如為新療程請先按確定!");
    //     } else {
    //         $.ajax({
    //             type: "POST",
    //             url: "/BaseInfo/setTreatmentHideValue",
    //             datatype: "json",
    //             data: { "treatmentId": id, "Hide": "N" },
    //             success: function (data) {
    //                 $('#vis-' + id).hide();
    //                 $('#vih-' + id).show();
    //             }
    //         });
    //     }
    // }

    function setTreatmentHide(id, hidevalue) {
        let alertMsg = "";

        var selectedLabels = [];
        document.querySelectorAll('input[name="labels"]:checked').forEach(function (checkbox) {
            selectedLabels.push(checkbox.value);
        });

        if ($('#treatmentName').val() == "")
            alertMsg = "請輸入療程名稱!!";
        else if ($('#introduction').val() == "")
            alertMsg = "請輸入療程介紹!!";
        else if ($('#time').val() == "")
            alertMsg = "請輸入療程時間!!";
        else if ($('#AlertMessage').val() == "")
            alertMsg = "請輸入衛教發送訊息!!";
        else if ($('#imageName').html() == "")
            alertMsg = "請上傳圖片!!";

        if (alertMsg != "") {
            alert(alertMsg);
            return false;
        }

        if (id == "") {
            alert("查無療程資料，如為新療程請先按確定!");
        } else {
            $.ajax({
                type: "POST",
                url: "/BaseInfo/setTreatmentHideValue",
                datatype: "json",
                data: { "treatmentId": id, "hide": hidevalue },
                success: function (data) {
                    if (hidevalue == "N") {
                        $('#vis-' + id).hide();
                        $('#vih-' + id).show();
                    } else {
                        $('#vis-' + id).show();
                        $('#vih-' + id).hide();
                    }


                }
            });
        }


    }

</script>